<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ontology Visualization</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100vh;
        background-color: #222;
        color: white;
        font-family: Arial, sans-serif;
      }
      .container {
        display: flex;
        height: 100vh;
        overflow: hidden;
        position: relative;
      }
      /* Graph panel */
      .graph {
        flex: 1;
        position: relative;
      }
      .graph iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
      }
      /* Drag bar between graph and sidebar */
      #dragbar {
        width: 5px;
        cursor: ew-resize;
        background-color: #444;
      }
      /* Sidebar styles */
      .sidebar {
        width: 300px;
        min-width: 200px;
        max-width: 600px;
        overflow-y: auto;
        background-color: #333;
        padding: 10px;
        display: flex;
        flex-direction: column;
      }
      #toggle-sidebar {
        background-color: #555;
        border: none;
        color: white;
        padding: 5px 10px;
        cursor: pointer;
        margin-bottom: 10px;
      }
      /* Sidebar reopen button */
      #sidebar-reopen {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #555;
        border: none;
        color: white;
        padding: 5px 10px;
        cursor: pointer;
        display: none;
        z-index: 1000;
      }
      .section {
        margin-bottom: 20px;
      }
      .section h2, .section h3, .section h4 {
        margin-top: 0;
      }
      .legend p {
        margin: 5px 0;
      }
      .legend-color {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 6px;
      }
      /* Node filter: type checkboxes and search input */
      .filter-section, .search-section {
        margin-bottom: 20px;
      }
      /* Relationship (edge) filter */
      .edge-filter-section {
        margin-bottom: 20px;
      }
      /* Interactive navigation section */
      .nav-section {
        margin-bottom: 20px;
      }
      /* Detailed Annotations toggle */
      .annotation-section {
        margin-bottom: 20px;
      }
      /* Collapsible tree styles */
      ul {
        list-style: none;
        padding-left: 20px;
      }
      li {
        margin: 5px 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .caret {
        cursor: pointer;
        user-select: none;
      }
      .caret:before {
        content: "\25B6";
        display: inline-block;
        margin-right: 6px;
      }
      .caret-down:before {
        transform: rotate(90deg);
      }
      .nested {
        display: none;
      }
      .active {
        display: block;
      }
      .highlight {
        background-color: #555;
      }
      /* Details panel */
      #details, #full-details {
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      #details {
        background-color: #444;
        padding: 10px;
        border-radius: 4px;
      }
      #full-details {
        display: none;
        margin-top: 10px;
        background-color: #555;
        padding: 10px;
        border-radius: 4px;
      }
      #toggle-all {
        margin-top: 10px;
        padding: 5px;
      }
      input[type="text"] {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Graph panel -->
      <div class="graph">
        <iframe src="{{ url_for('static', filename='graph.html') }}"></iframe>
      </div>
      <!-- Drag bar for resizing -->
      <div id="dragbar"></div>
      <!-- Sidebar panel -->
      <div class="sidebar" id="sidebar">
        <button id="toggle-sidebar">Collapse Sidebar</button>
        <!-- Legend Section -->
        <div class="section legend">
          <h3>Key</h3>
          <p><span class="legend-color" style="background-color: #3498db;"></span> Class</p>
          <p><span class="legend-color" style="background-color: #e67e22;"></span> Property</p>
          <p><span class="legend-color" style="background-color: #2ecc71;"></span> Individual</p>
        </div>
        <!-- Node Filter Section -->
        <div class="section filter-section">
          <h3>Filter Nodes</h3>
          <label><input type="checkbox" class="filter-checkbox" data-group="class" checked> Class</label><br>
          <label><input type="checkbox" class="filter-checkbox" data-group="property" checked> Property</label><br>
          <label><input type="checkbox" class="filter-checkbox" data-group="individual" checked> Individual</label>
        </div>
        <!-- Search Section -->
        <div class="section search-section">
          <h3>Search Nodes</h3>
          <input type="text" id="search-input" placeholder="Enter search text">
        </div>
        <!-- Edge Filter Section -->
        <div class="section edge-filter-section">
          <h3>Filter Edges</h3>
          <label><input type="checkbox" class="edge-filter" data-edge="subClassOf" checked> Subclass Relationships</label><br>
          <label><input type="checkbox" class="edge-filter" data-edge="instance_of" checked> Instance Relationships</label><br>
          <label><input type="checkbox" class="edge-filter" data-edge="domain" checked> Domain Relationships</label><br>
          <label><input type="checkbox" class="edge-filter" data-edge="range" checked> Range Relationships</label>
        </div>
        <!-- Interactive Navigation Section -->
        <div class="section nav-section">
          <h3>Interactive Navigation</h3>
          <button id="reset-view">Reset Graph View</button>
        </div>
        <!-- Detailed Annotations Section -->
        <div class="section annotation-section">
          <h3>Detailed Annotations</h3>
          <label><input type="checkbox" id="toggle-detailed"> Show Detailed Annotations by default</label>
        </div>
        <!-- Hierarchy Section -->
        <div class="section hierarchy">
          <h2>Ontology Hierarchy</h2>
          {{ tree_html|safe }}
        </div>
        <!-- Details Section -->
        <div class="section details">
          <h2>Details</h2>
          <div id="details">Select a node to see details.</div>
          <button id="toggle-all" style="display:none;">Show All Info</button>
          <div id="full-details"></div>
        </div>
      </div>
      <!-- Sidebar reopen button -->
      <button id="sidebar-reopen">&#9776;</button>
    </div>
    <script>
      // Collapsible tree toggles.
      var toggler = document.getElementsByClassName("caret");
      for (var i = 0; i < toggler.length; i++) {
        toggler[i].addEventListener("click", function(e) {
          e.stopPropagation();
          var nested = this.parentElement.querySelector(".nested");
          if (nested) {
            nested.classList.toggle("active");
            this.classList.toggle("caret-down");
          }
        });
      }
      
      // Expand ancestors of an element.
      function expandAncestors(elem) {
        var parent = elem.parentElement;
        while (parent) {
          if (parent.classList.contains("nested") && !parent.classList.contains("active")) {
            parent.classList.add("active");
            var li = parent.parentElement;
            if (li) {
              var caret = li.querySelector(".caret");
              if (caret && !caret.classList.contains("caret-down")) {
                caret.classList.add("caret-down");
              }
            }
          }
          parent = parent.parentElement;
        }
      }
      
      // Highlight hierarchy node and fetch node details.
      function highlightHierarchy(nodeId) {
        document.querySelectorAll('.highlight').forEach(function(el) {
          el.classList.remove('highlight');
        });
        var sanitizedId = "node_" + nodeId.replace(/[^a-zA-Z0-9_]+/g, "_");
        var elem = document.getElementById(sanitizedId);
        if (elem) {
          expandAncestors(elem);
          elem.classList.add("highlight");
          elem.scrollIntoView({ behavior: "smooth", block: "center" });
        }
        fetch('/node_info?node_id=' + encodeURIComponent(nodeId))
          .then(response => response.json())
          .then(data => {
            var detailsDiv = document.getElementById('details');
            if (data.error) {
              detailsDiv.innerHTML = '<p>Error: ' + data.error + '</p>';
              document.getElementById('toggle-all').style.display = "none";
              document.getElementById('full-details').style.display = "none";
            } else {
              var html = '<h3>' + data.label + '</h3>' +
                         '<p><strong>IRI:</strong> ' + data.iri + '</p>' +
                         '<p><strong>Type:</strong> ' + data.type + '</p>';
              if (data.comment) {
                html += '<p><strong>Comment:</strong> ' + data.comment + '</p>';
              }
              detailsDiv.innerHTML = html;
              var fullHtml = '<h4>All Details</h4><ul>';
              for (var key in data.all_details) {
                fullHtml += '<li><strong>' + key + ':</strong> ' + data.all_details[key] + '</li>';
              }
              fullHtml += '</ul>';
              var fullDetailsDiv = document.getElementById('full-details');
              fullDetailsDiv.innerHTML = fullHtml;
              if (Object.keys(data.all_details).length > 0) {
                document.getElementById('toggle-all').style.display = "block";
              } else {
                document.getElementById('toggle-all').style.display = "none";
              }
              // If "Show Detailed Annotations" is checked, display details immediately.
              if (document.getElementById('toggle-detailed').checked) {
                fullDetailsDiv.style.display = "block";
                document.getElementById('toggle-all').textContent = "Hide All Info";
              } else {
                fullDetailsDiv.style.display = "none";
                document.getElementById('toggle-all').textContent = "Show All Info";
              }
            }
          })
          .catch(error => {
            console.error('Error fetching node details:', error);
          });
      }
      
      document.getElementById('toggle-all').addEventListener('click', function() {
        var fullDetailsDiv = document.getElementById('full-details');
        if (fullDetailsDiv.style.display === "none") {
          fullDetailsDiv.style.display = "block";
          this.textContent = "Hide All Info";
        } else {
          fullDetailsDiv.style.display = "none";
          this.textContent = "Show All Info";
        }
      });
      
      window.highlightHierarchy = highlightHierarchy;
      
      // Sidebar toggle functionality.
      var sidebar = document.getElementById('sidebar');
      var toggleSidebarBtn = document.getElementById('toggle-sidebar');
      var sidebarReopen = document.getElementById('sidebar-reopen');
      toggleSidebarBtn.addEventListener('click', function() {
        sidebar.style.display = "none";
        document.getElementById('dragbar').style.display = "none";
        sidebarReopen.style.display = "block";
      });
      
      sidebarReopen.addEventListener('click', function() {
        sidebar.style.display = "flex";
        document.getElementById('dragbar').style.display = "block";
        sidebarReopen.style.display = "none";
      });
      
      // Drag bar for resizing sidebar.
      var dragbar = document.getElementById('dragbar');
      var container = document.getElementsByClassName('container')[0];
      var isResizing = false;
      
      dragbar.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.body.style.cursor = 'ew-resize';
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        var containerRect = container.getBoundingClientRect();
        var newWidth = containerRect.right - e.clientX;
        if (newWidth < 200) newWidth = 200;
        if (newWidth > 600) newWidth = 600;
        sidebar.style.width = newWidth + 'px';
      });
      
      document.addEventListener('mouseup', function(e) {
        isResizing = false;
        document.body.style.cursor = 'default';
      });
      
      // Combine node type filter and search filter.
      function sendNodeFilterUpdate() {
        var checkboxes = document.querySelectorAll('.filter-checkbox');
        var nodeTypes = {};
        checkboxes.forEach(function(cb) {
          var group = cb.getAttribute('data-group');
          nodeTypes[group] = cb.checked;
        });
        var search = document.getElementById('search-input').value || "";
        var iframe = document.querySelector('.graph iframe');
        iframe.contentWindow.postMessage({type: "updateNodeFilter", nodeTypes: nodeTypes, search: search}, "*");
      }
      
      document.querySelectorAll('.filter-checkbox').forEach(function(cb) {
        cb.addEventListener('change', sendNodeFilterUpdate);
      });
      document.getElementById('search-input').addEventListener('input', sendNodeFilterUpdate);
      
      // Edge filter: send update to toggle edges.
      function sendEdgeFilterUpdate() {
        var checkboxes = document.querySelectorAll('.edge-filter');
        var edges = {};
        checkboxes.forEach(function(cb) {
          var edgeType = cb.getAttribute('data-edge');
          edges[edgeType] = cb.checked;
        });
        var iframe = document.querySelector('.graph iframe');
        iframe.contentWindow.postMessage({type: "toggleEdges", edges: edges}, "*");
      }
      
      document.querySelectorAll('.edge-filter').forEach(function(cb) {
        cb.addEventListener('change', sendEdgeFilterUpdate);
      });
      
      // Reset Graph View button.
      document.getElementById('reset-view').addEventListener('click', function() {
        var iframe = document.querySelector('.graph iframe');
        iframe.contentWindow.postMessage({type: "resetView"}, "*");
      });
      
      // Send initial filters on load.
      window.addEventListener('load', function() {
        sendNodeFilterUpdate();
        sendEdgeFilterUpdate();
      });
    </script>
  </body>
</html>
